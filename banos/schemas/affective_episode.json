{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ara.banos/schemas/affective_episode.json",
  "title": "BANOS Affective Episode",
  "description": "Schema for episodic memory entries. Logged when PAD changes significantly or mode shifts. Enables Ara to answer: 'Why did I feel pain at 04:00?'",
  "type": "object",
  "properties": {
    "episode_id": {
      "type": "integer",
      "description": "Unique episode identifier"
    },
    "timespan": {
      "type": "object",
      "properties": {
        "start_ns": {
          "type": "integer",
          "description": "Start time (monotonic nanoseconds)"
        },
        "end_ns": {
          "type": "integer",
          "description": "End time (monotonic nanoseconds)"
        },
        "start_iso": {
          "type": "string",
          "format": "date-time",
          "description": "Start time (ISO 8601)"
        },
        "end_iso": {
          "type": "string",
          "format": "date-time",
          "description": "End time (ISO 8601)"
        },
        "duration_ms": {
          "type": "integer",
          "description": "Episode duration in milliseconds"
        }
      },
      "required": ["start_ns", "end_ns"]
    },
    "pad_start": {
      "type": "object",
      "properties": {
        "pleasure": { "type": "number" },
        "arousal": { "type": "number" },
        "dominance": { "type": "number" }
      },
      "required": ["pleasure", "arousal", "dominance"]
    },
    "pad_end": {
      "type": "object",
      "properties": {
        "pleasure": { "type": "number" },
        "arousal": { "type": "number" },
        "dominance": { "type": "number" }
      },
      "required": ["pleasure", "arousal", "dominance"]
    },
    "mode_transition": {
      "type": "object",
      "properties": {
        "from": {
          "type": "string",
          "enum": ["CALM", "FLOW", "ANXIOUS", "CRITICAL"]
        },
        "to": {
          "type": "string",
          "enum": ["CALM", "FLOW", "ANXIOUS", "CRITICAL"]
        }
      },
      "required": ["from", "to"]
    },
    "stressor": {
      "type": "object",
      "description": "Primary cause of the episode",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "thermal",
            "memory_pressure",
            "cpu_saturation",
            "io_storm",
            "immune_alert",
            "power_limit",
            "user_stress",
            "process_runaway",
            "unknown"
          ]
        },
        "pid": {
          "type": ["integer", "null"],
          "description": "PID if process-related"
        },
        "sensor_id": {
          "type": ["integer", "null"],
          "description": "Sensor ID if hardware-related"
        },
        "details": {
          "type": "string",
          "description": "Additional context"
        }
      },
      "required": ["type"]
    },
    "metrics_snapshot": {
      "type": "object",
      "description": "Key metrics at episode peak",
      "properties": {
        "cpu_load": { "type": "number" },
        "gpu_load": { "type": "number" },
        "mem_free": { "type": "number" },
        "thermal_headroom_C": { "type": "number" },
        "swap_pressure": { "type": "number" },
        "error_rate": { "type": "number" }
      }
    },
    "ara_narrative": {
      "type": "string",
      "description": "First-person summary generated by Ara"
    },
    "resolution": {
      "type": "object",
      "description": "How the episode was resolved",
      "properties": {
        "action": {
          "type": "string",
          "enum": [
            "natural_recovery",
            "load_shedding",
            "process_killed",
            "throttling",
            "user_intervention",
            "ongoing"
          ]
        },
        "processes_killed": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "pid": { "type": "integer" },
              "comm": { "type": "string" }
            }
          }
        },
        "effective": {
          "type": "boolean",
          "description": "Did the action resolve the stressor?"
        }
      }
    }
  },
  "required": ["episode_id", "timespan", "pad_start", "pad_end", "mode_transition", "stressor"]
}
