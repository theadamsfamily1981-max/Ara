name: Viz Build

on:
  push:
    branches: [ main, 'claude/**' ]
    paths:
      - 'viz/topo_attn_dashboard/**'
      - 'tfan/viz/**'
      - '.github/workflows/viz_build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'viz/topo_attn_dashboard/**'
      - 'tfan/viz/**'
      - '.github/workflows/viz_build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: viz/topo_attn_dashboard

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: viz/topo_attn_dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci || npm i

      - name: Build Next.js app
        run: npm run build

      - name: Export static site (optional)
        run: npm run build
        continue-on-error: true

      - name: Check for build artifacts
        run: |
          if [ -d ".next" ]; then
            echo "✓ Build successful"
            ls -lh .next/
          else
            echo "✗ Build failed - no .next directory"
            exit 1
          fi

  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install websockets numpy

      - name: Test backend imports
        run: |
          python -c "
          from tfan.viz import VizStream, encode_pd, encode_attention_matrix
          print('✓ Backend imports successful')
          "

      - name: Test demo emitter (dry run)
        run: |
          timeout 5 python scripts/emit_demo_metrics.py --port 8766 || true
          echo "✓ Demo emitter runs without errors"

  integration:
    runs-on: ubuntu-latest
    needs: [build, test-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd viz/topo_attn_dashboard
          npm ci || npm i
          cd ../..
          pip install websockets numpy

      - name: Start backend in background
        run: |
          python scripts/emit_demo_metrics.py --port 8765 &
          echo $! > /tmp/backend.pid
          sleep 3

      - name: Test WebSocket connection
        run: |
          python -c "
          import asyncio
          import websockets
          import json

          async def test():
              async with websockets.connect('ws://localhost:8765') as ws:
                  # Wait for message
                  msg = await asyncio.wait_for(ws.recv(), timeout=5.0)
                  data = json.loads(msg)
                  assert 'type' in data, 'Message missing type field'
                  print(f'✓ Received message type: {data[\"type\"]}')
                  return True

          result = asyncio.run(test())
          assert result, 'WebSocket test failed'
          print('✓ WebSocket integration test passed')
          "

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/backend.pid ]; then
            kill $(cat /tmp/backend.pid) || true
          fi
