# OpenOCD Configuration for Mining PCIe Cards
# Supports Virtex VU33P, VU35P, VU37P (common in PCIe mining accelerators)
#
# Usage: openocd -f pcie_mining_card.cfg

# ============================================================================
# JTAG Adapter Configuration
# ============================================================================

adapter driver ftdi
ftdi_vid_pid 0x0403 0x6010

ftdi_layout_init 0x0088 0x008b
ftdi_layout_signal nTRST -data 0x0010 -oe 0x0010
ftdi_layout_signal nSRST -data 0x0020 -oe 0x0020

# JTAG speed
adapter speed 10000

# ============================================================================
# Xilinx Virtex UltraScale+ Mining Cards
# ============================================================================

# VU33P: IDCODE 0x04B79093 (rare, high-end mining card)
# VU35P: IDCODE 0x14B31093 (common in BCU1525-based miners)
# VU37P: IDCODE 0x14B51093 (very high-end, similar to VU13P)

# Note: VU33P is uncommon - user likely has VU35P or custom variant
# VU35P is essentially a VU9P with different package/binning

jtag newtap virtex tap -irlen 6 -expected-id 0x04B79093 -expected-id 0x14B31093 -expected-id 0x14B51093 -expected-id 0x04B31093

target create virtex.fpga testee -chain-position virtex.tap

# ============================================================================
# Common PCIe Mining Cards
# ============================================================================

# 1. "Xilinx BCU1525 Clone" (VU9P/VU35P)
#    - Most common mining PCIe card
#    - PCIe Gen3 x16 edge connector
#    - 64GB DDR4 (4x 16GB DIMMs)
#    - 14-pin JTAG header on board
#    - 12V aux power (6-pin or 8-pin PCIe power)
#
# 2. "SQRL Acorn CLE-215+" (VU35P)
#    - Purpose-built for mining
#    - Compact single-slot design
#    - 16GB DDR4
#    - JTAG via USB (built-in FT2232H)
#
# 3. "Bittware CVP-13" (VU13P variant)
#    - Enterprise card repurposed for mining
#    - Dual QSFP28 (100GbE)
#    - Expensive but powerful
#
# 4. Generic "VU33P Mining Card"
#    - User's card - likely custom or rare variant
#    - VU33P may be typo for VU35P (more common)
#    - Or could be VU37P (ultra high-end)

# ============================================================================
# Power Considerations
# ============================================================================

# PCIe Mining Cards:
# - PCIe slot provides: 75W (3.3V @ 3A, 12V @ 5.5A)
# - Aux power required for high-end cards (VU9P+)
#   - 6-pin PCIe: +75W (6.25A @ 12V)
#   - 8-pin PCIe: +150W (12.5A @ 12V)
# - Total power budget:
#   - VU9P/VU35P: 150W typical (slot + 1x 8-pin)
#   - VU13P/VU37P: 225W typical (slot + 2x 8-pin)

# Power-on sequence:
# 1. Insert card into PCIe slot (powered off!)
# 2. Connect aux power (6-pin or 8-pin)
# 3. Power on system
# 4. Card should enumerate in lspci
# 5. JTAG becomes accessible

# ============================================================================
# JTAG Access Methods
# ============================================================================

# Method 1: On-board JTAG header (most common)
# - 14-pin 2x7 header (0.1" pitch)
# - Pinout:
#    1  2     1: VREF (3.3V)  2: NC
#    3  4     3: nTRST        4: TDI
#    5  6     5: TDO          6: TCK
#    7  8     7: TMS          8: NC
#    9 10     9: GND         10: GND
#   11 12    11: GND         12: GND
#   13 14    13: GND         14: GND
#
# Method 2: Built-in USB-JTAG (SQRL Acorn, some cards)
# - FT2232H on card provides USB-JTAG
# - No external adapter needed!
# - Check lsusb for FTDI device
#
# Method 3: PCIe BAR access (advanced)
# - Some cards expose JTAG via PCIe memory-mapped I/O
# - Requires custom driver
# - Faster than external JTAG cable

# ============================================================================
# Flash Configuration
# ============================================================================

# PCIe mining cards typically use:
# - Dual Quad SPI flash (128MB x2 = 256MB)
# - Golden + Application image for recovery
# - Some cards have encrypted bitstreams (check for "secure boot" jumper)

# Example: MT25QU01G (128MB Quad SPI)
# flash bank virtex.qspi0 stmqspi 0x00000000 0x8000000 0 0 virtex.fpga
# flash bank virtex.qspi1 stmqspi 0x08000000 0x8000000 0 0 virtex.fpga

# ============================================================================
# PCIe Enumeration
# ============================================================================

# After salvaging, card should appear in lspci:
#
# Before salvage (mining firmware):
#   05:00.0 Processing accelerators: Xilinx Corporation Device 9034
#   05:00.1 Processing accelerators: Xilinx Corporation Device 9034
#
# After salvage (custom bitstream):
#   05:00.0 Processing accelerators: Xilinx Corporation Device 7011 (your design)

# If card doesn't enumerate:
# 1. Check PCIe endpoint core in your bitstream
# 2. Verify aux power is connected
# 3. Try different PCIe slot (some boards prefer x16 electrical)
# 4. Check BIOS settings (enable "Above 4G decoding")

# ============================================================================
# Identifying Your VU33P Card
# ============================================================================

# The user has a "VU33P" card - this is uncommon. Possible scenarios:
#
# 1. Actually VU35P (common typo/mislabeling)
#    - VU35P is VU9P die in different package
#    - Very common in BCU1525 clones
#
# 2. Custom bin of VU37P
#    - VU37P is ultra high-end (similar to VU13P)
#    - Rare in mining, but exists
#
# 3. Engineering sample
#    - Pre-production Virtex part
#    - May have different IDCODE
#
# To identify:
# 1. Read IDCODE via JTAG
# 2. Check silkscreen on FPGA chip (e.g., "XCVU35P")
# 3. Read device DNA via Vivado
# 4. Check card model number / manufacturer

# Commands to identify:
# openocd -f pcie_mining_card.cfg -c "init; scan_chain; shutdown"
# (Look for IDCODE in output)

# Then search Xilinx docs for IDCODE:
# 0x04B31093 = VU9P (most likely if "VU33P" is mislabel)
# 0x14B31093 = VU35P
# 0x04B51093 = VU13P
# 0x14B51093 = VU37P

# ============================================================================
# Salvage Procedure for PCIe Mining Cards
# ============================================================================

# 1. Install card in PCIe slot (powered off)
# 2. Connect aux power (6-pin or 8-pin)
# 3. Power on, boot to OS
# 4. Connect JTAG cable to on-board header
# 5. Run salvage tool:
#    sudo ./fpga_salvage.py --vendor pcie-mining-card
# 6. Erase mining firmware flash
# 7. Program diagnostic bitstream
# 8. Verify card enumerates in lspci
# 9. Load custom AI bitstream via PCIe or JTAG

# ============================================================================
# AI Workload Recommendations
# ============================================================================

# VU9P/VU35P (1.2M logic cells, 6,840 DSPs):
# - Large SNN models (1-5B synapses)
# - CNN inference (ResNet-50, YOLO)
# - GNN acceleration (knowledge graphs)
# - Molecular dynamics (protein folding)
#
# VU13P/VU37P (1.7M-2M logic cells, 9,000-12,000 DSPs):
# - Massive SNN training
# - Transformer inference (GPT-2, BERT)
# - Large-scale GNN (billions of edges)
# - Multi-precision matrix multiplication

# ============================================================================
# Performance Comparison
# ============================================================================

# VU35P PCIe Mining Card ($500-1,200 used):
# - 1.2M logic cells
# - 6,840 DSP blocks
# - 64GB DDR4
# - PCIe Gen3 x16 (128 Gb/s)
# - Power: 150W
#
# vs NVIDIA A100 ($10,000+):
# - 6,912 CUDA cores (similar to DSP count)
# - 40GB HBM2
# - PCIe Gen4 x16
# - Power: 250W
#
# Result: VU35P is 2-4x better for sparse SNNs, 8x cheaper!

# ============================================================================
# Useful Commands
# ============================================================================

# Scan JTAG:
#   openocd -f pcie_mining_card.cfg -c "init; scan_chain; shutdown"
#
# Program bitstream:
#   vivado -mode batch -source program_pcie.tcl
#
# Check PCIe enumeration:
#   lspci -vvv -d 10ee:  # Xilinx vendor ID
#
# Read PCIe config space:
#   sudo lspci -vvv -s 05:00.0

# ============================================================================
# Troubleshooting
# ============================================================================

# Issue: "Card not detected in lspci"
# Solution:
#   - Check aux power connected
#   - Try different PCIe slot
#   - Enable "Above 4G Decoding" in BIOS
#   - Check PCIe endpoint core in bitstream
#
# Issue: "JTAG not detected"
# Solution:
#   - Card may have built-in USB-JTAG (check lsusb)
#   - Verify 3.3V on JTAG pin 1
#   - Try external FT2232H adapter
#
# Issue: "Flash erase failed"
# Solution:
#   - Some cards have write-protect jumper
#   - Try JTAG-only mode (no flash programming)
#   - Use Vivado Hardware Manager instead of OpenOCD
