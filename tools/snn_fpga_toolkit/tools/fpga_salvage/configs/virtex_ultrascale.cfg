# OpenOCD Configuration for Xilinx Virtex UltraScale+ FPGAs
# Common in high-end cryptocurrency mining hardware
#
# Usage: openocd -f virtex_ultrascale.cfg

# ============================================================================
# JTAG Adapter Configuration
# ============================================================================

# Common adapters for Xilinx FPGAs:
# - Xilinx Platform Cable USB II
# - Digilent HS2/HS3
# - FT2232H-based generic cables

# Option 1: FTDI FT2232H (most common for DIY/repurposed boards)
adapter driver ftdi
ftdi_vid_pid 0x0403 0x6010

# Standard JTAG pinout for FT2232H
ftdi_layout_init 0x0088 0x008b
ftdi_layout_signal nTRST -data 0x0010 -oe 0x0010
ftdi_layout_signal nSRST -data 0x0020 -oe 0x0020

# Option 2: Digilent HS2 (if available)
# adapter driver ftdi
# ftdi_vid_pid 0x0403 0x6014
# ftdi_channel 0
# ftdi_layout_init 0x00e8 0x60eb

# JTAG speed (Virtex UltraScale+ supports up to 30MHz)
adapter speed 10000

# ============================================================================
# Virtex UltraScale+ Target Configuration
# ============================================================================

# Virtex UltraScale+ JTAG IDCODE variants:
# - VU9P:  0x04B31093 (common in mining, 1.2M logic cells)
# - VU13P: 0x04B51093 (high-end, 1.7M logic cells)
# - VU19P: 0x14B79093 (massive, 9M logic cells - rare in mining)

# JTAG chain for single VU device
jtag newtap virtex tap -irlen 6 -expected-id 0x04B31093 -expected-id 0x04B51093 -expected-id 0x14B79093

# Xilinx 7-series/UltraScale use BSCAN for debugging
target create virtex.fpga testee -chain-position virtex.tap

# ============================================================================
# Configuration Memory (Flash)
# ============================================================================

# Virtex UltraScale+ typically uses:
# - BPI Flash (x16 parallel NOR) - 128MB to 512MB
# - Quad SPI (x4 serial NOR) - Faster boot
# - SD/eMMC (some mining boards)

# Example: Quad SPI Flash (Micron MT25QU01G - 128MB)
# Note: Actual flash programming requires Vivado or custom SVF
# flash bank virtex.qspi stmqspi 0x00000000 0 0 0 virtex.fpga 0x44000000

# ============================================================================
# Mining Board Specific Configurations
# ============================================================================

# Common Virtex UltraScale+ mining boards:
#
# 1. Osprey E300 (VU13P)
#    - 8x VU13P FPGAs
#    - 64GB HBM2 per FPGA
#    - Custom bitstream loader in flash
#    - JTAG chain: 8 devices
#
# 2. Squire VCU1525 Clone (VU9P)
#    - Single VU9P (xcvu9p-flgb2104)
#    - 64GB DDR4 (4x 16GB DIMMs)
#    - Standard Xilinx flash configuration
#
# 3. Custom mining rigs (various)
#    - Often have locked flash with encrypted bitstreams
#    - May require voltage glitching for initial access

# For multi-FPGA chains (e.g., 4x VU9P):
# jtag newtap virtex0 tap -irlen 6 -expected-id 0x04B31093
# jtag newtap virtex1 tap -irlen 6 -expected-id 0x04B31093
# jtag newtap virtex2 tap -irlen 6 -expected-id 0x04B31093
# jtag newtap virtex3 tap -irlen 6 -expected-id 0x04B31093

# ============================================================================
# Bitstream Security Bypass
# ============================================================================

# Many mining boards use Xilinx bitstream encryption (AES-256)
# To bypass:
#   1. Erase configuration flash (removes encrypted bitstream)
#   2. Boot via JTAG with unencrypted diagnostic bitstream
#   3. Reprogram flash with open-source bitstream

# Xilinx UltraScale+ eFUSE access (DANGER: Irreversible!)
# proc read_efuse {row} {
#     irscan virtex.tap 0x0C
#     drscan virtex.tap 32 $row
# }

# DO NOT write eFUSEs unless you know what you're doing!
# Writing incorrect values can permanently brick the device.

# ============================================================================
# Useful Commands
# ============================================================================

# Scan JTAG chain:
#   openocd -f virtex_ultrascale.cfg -c "init; scan_chain; shutdown"
#
# Read device DNA (unique ID):
#   openocd -f virtex_ultrascale.cfg -c "init; irscan virtex.tap 0x31; drscan virtex.tap 64 0; shutdown"
#
# Program bitstream (requires Vivado or SVF file):
#   vivado -mode batch -source program.tcl
#
# Check FPGA temperature (requires XADC/SYSMON access):
#   Custom JTAG sequences needed (not supported in stock OpenOCD)

# ============================================================================
# Troubleshooting
# ============================================================================

# Issue: JTAG IDCODE not recognized
# Fix: Check board power, JTAG pinout, and cable connections
#
# Issue: "Flash erase failed"
# Fix: Mining boards may have write-protected flash - check WP pin
#
# Issue: Bitstream won't load
# Fix: Ensure bitstream matches device (e.g., VU9P bitstream for VU9P chip)
#      Check for bitstream encryption (golden lock icon in Vivado)
