# OpenOCD Configuration for BittWare A10PED (Dual Arria 10 GX1150)
#
# Board: BittWare A10PED
# FPGAs: 2x Intel Arria 10 GX1150 (10AX115H1F34I1SG)
# Interface: PCIe Gen3 x8
# Memory: 2x 16GB DDR4 (32GB total), optional HMC
# I/O: 2x QSFP28, Avago fiber optics
#
# This config supports JTAG access to both FPGAs via the onboard
# USB-Blaster II circuit or external JTAG header.
#
# Power: 75W TDP (much more reasonable than K10/P2!)
#
# Usage:
#   openocd -f arria10_bittware_a10ped.cfg
#
# Author: FPGA Salvage Project
# Date: 2024
# License: GPL-3.0

# ============================================================================
# JTAG Adapter Configuration
# ============================================================================

# BittWare A10PED typically uses onboard USB-Blaster II
# If using external JTAG header, change to appropriate adapter

adapter driver usb_blaster
# usb_blaster_vid_pid 0x09fb 0x6010  # Intel USB-Blaster II
# usb_blaster_device_desc "Terasic DE10"

# JTAG clock speed
# Start conservative, can increase to 10MHz after successful connection
adapter speed 2000

# Reset configuration
# SRST (system reset) may not be connected on PCIe cards
reset_config none

# ============================================================================
# Arria 10 GX1150 JTAG Chain Definition (Dual FPGAs)
# ============================================================================

# The A10PED has TWO Arria 10 FPGAs in a JTAG chain
# FPGA 0: Primary (closest to PCIe edge connector)
# FPGA 1: Secondary

# JTAG TAP for Arria 10 GX1150 FPGA 0 (Primary)
jtag newtap arria10_fpga0 tap -irlen 10 \
    -expected-id 0x02E660DD \
    -expected-id 0x02E620DD \
    -expected-id 0x02E650DD

# JTAG TAP for Arria 10 GX1150 FPGA 1 (Secondary)
jtag newtap arria10_fpga1 tap -irlen 10 \
    -expected-id 0x02E660DD \
    -expected-id 0x02E620DD \
    -expected-id 0x02E650DD

# IDCODE Guide for Arria 10 GX variants:
# 0x02E660DD - Arria 10 GX1150 (most common on A10PED)
# 0x02E620DD - Arria 10 GX660
# 0x02E650DD - Arria 10 GX480

# Note: Some boards may have mixed variants
# Use: openocd -f this_config.cfg -c "init; scan_chain; shutdown"
# to detect actual IDCODEs

# ============================================================================
# FPGA Target Configuration
# ============================================================================

# Create targets for both FPGAs
target create arria10_fpga0.tap testee -chain-position arria10_fpga0.tap
target create arria10_fpga1.tap testee -chain-position arria10_fpga1.tap

# ============================================================================
# Configuration Flash Memory (Optional)
# ============================================================================

# A10PED uses Quad SPI flash for configuration storage
# Typical: Micron MT25Q series (256Mb - 1Gb)

# To access flash (advanced users only):
# 1. Init: openocd -f this_config.cfg
# 2. Telnet: telnet localhost 4444
# 3. Commands:
#    > init
#    > svf /path/to/flash_programming.svf
#    > shutdown

# WARNING: Erasing flash removes BittWare factory bitstream!
# Ensure you have backup before proceeding.

# ============================================================================
# Boundary Scan (I/O Pin Mapping)
# ============================================================================

# Use boundary scan to identify critical I/O connections:
# - DDR4 memory interface pins
# - PCIe transceiver lanes (Gen3 x8)
# - QSFP28 high-speed I/O
# - Management interfaces (I2C, SPI)

# Commands (via telnet to port 4444):
#   > init
#   > scan_chain
#   > irscan arria10_fpga0.tap 0x00E  # EXTEST instruction
#   > drscan arria10_fpga0.tap 4096 0 # Read boundary scan register
#   > shutdown

# ============================================================================
# Advanced: PCIe Enumeration Detection
# ============================================================================

# After programming custom bitstream, verify PCIe detection:
# lspci | grep -i altera
# Should show: 01:00.0 Processing accelerators: Intel Corporation Device XXXX

# If not detected:
# 1. Check PCIe refclk (100MHz) with scope
# 2. Verify PERST# signal (active low reset from host)
# 3. Check PCIe TX/RX lane integrity
# 4. Ensure bitstream includes PCIe Hard IP configuration

# ============================================================================
# Safety Notes
# ============================================================================

# 1. Power: A10PED draws 75W from PCIe slot
#    - Ensure motherboard PCIe slot can supply sufficient power
#    - Some configs may need 6-pin PCIe aux power connector
#
# 2. Cooling: Stock heatsinks are adequate for 75W
#    - Ensure airflow in chassis (chassis fans recommended)
#    - Monitor temps during high utilization
#
# 3. ESD Protection: Use anti-static wrist strap when handling
#
# 4. Bitstream Backup: Always backup factory bitstream before erasing:
#    openocd -f this_config.cfg -c "init; dump_image factory_backup.bin 0x0 0x10000000; shutdown"

# ============================================================================
# Troubleshooting
# ============================================================================

# Issue: "Error: JTAG scan chain interrogation failed"
# Fix:
#   - Check USB-Blaster connection (lsusb | grep Altera)
#   - Verify board is powered (PCIe slot + aux power if needed)
#   - Try slower JTAG speed: adapter speed 1000
#   - Check for solder bridges on JTAG header

# Issue: "Warn: JTAG tap: arria10_fpga0.tap unexpected IDCODE"
# Fix:
#   - Run scan_chain to see actual IDCODE
#   - Update -expected-id in this config
#   - Different Arria 10 variant may be installed

# Issue: "Error: Cannot erase flash"
# Fix:
#   - Flash may be write-protected (check WP# pin)
#   - Use Intel Quartus Programmer instead of OpenOCD for flash
#   - Some enterprise boards have permanent write-protect

# ============================================================================
# Next Steps After Successful Connection
# ============================================================================

# 1. Extract Factory Bitstream:
#    openocd -f this_config.cfg -c "init; dump_image factory.bin 0x0 0x10000000; shutdown"
#
# 2. Load Custom Bitstream (SRAM, volatile):
#    openocd -f this_config.cfg -c "init; svf my_bitstream.svf; shutdown"
#
# 3. Program Flash (Persistent):
#    Use Quartus Programmer: quartus_pgm -m jtag -o "p;my_bitstream.sof"
#
# 4. AI Deployment:
#    See: docs/ARRIA10_AI_DEPLOYMENT.md
#    Use: Intel FPGA AI Suite, OpenVINO, or custom OpenCL kernels

# ============================================================================
# References
# ============================================================================

# - BittWare A10PED Product Brief: https://www.bittware.com/fpga/a10ped/
# - Intel Arria 10 Handbook: https://www.intel.com/content/www/us/en/docs/programmable/683662/
# - OpenOCD Manual: http://openocd.org/doc/html/index.html
# - FPGA Salvage Guides: docs/ARRIA10_SALVAGE_GUIDE.md

# ============================================================================
# End of Configuration
# ============================================================================
