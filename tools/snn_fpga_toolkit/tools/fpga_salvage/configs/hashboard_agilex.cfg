# OpenOCD Configuration for Mining Hashboards with Intel Agilex FPGAs
# Common in cryptocurrency mining ASICs (Ethereum, Bitcoin variants)
#
# Usage: openocd -f hashboard_agilex.cfg

# ============================================================================
# JTAG Adapter Configuration
# ============================================================================

# Mining hashboards typically use:
# - On-board JTAG headers (10-pin or 14-pin, often unpopulated)
# - JTAG shared across multiple FPGAs in daisy-chain
# - May require external pull-ups (10K to 3.3V)

adapter driver ftdi
ftdi_vid_pid 0x0403 0x6010

ftdi_layout_init 0x0088 0x008b
ftdi_layout_signal nTRST -data 0x0010 -oe 0x0010
ftdi_layout_signal nSRST -data 0x0020 -oe 0x0020

# JTAG speed (conservative for hashboards with long traces)
adapter speed 2000

# ============================================================================
# Intel Agilex JTAG Configuration (Multi-Chip)
# ============================================================================

# Intel Agilex 7 (Common in 2020+ mining hardware)
# IDCODE: 0x02E120DD (Agilex 7 F-Series)
#         0x02E320DD (Agilex 7 I-Series)

# IMPORTANT: Hashboards with 4x Agilex chips have all 4 in JTAG chain!
# Chain order (typical): FPGA0 -> FPGA1 -> FPGA2 -> FPGA3

# Chip 0 (first in chain, closest to JTAG connector)
jtag newtap agilex0 tap -irlen 10 -expected-id 0x02E120DD -expected-id 0x02E320DD

# Chip 1
jtag newtap agilex1 tap -irlen 10 -expected-id 0x02E120DD -expected-id 0x02E320DD

# Chip 2
jtag newtap agilex2 tap -irlen 10 -expected-id 0x02E120DD -expected-id 0x02E320DD

# Chip 3
jtag newtap agilex3 tap -irlen 10 -expected-id 0x02E120DD -expected-id 0x02E320DD

# Create targets (one per chip)
target create agilex0.fpga testee -chain-position agilex0.tap
target create agilex1.fpga testee -chain-position agilex1.tap
target create agilex2.fpga testee -chain-position agilex2.tap
target create agilex3.fpga testee -chain-position agilex3.tap

# ============================================================================
# Mining Hashboard Specifics
# ============================================================================

# Common Agilex Mining Hashboards:
#
# 1. "Linzhi Phoenix" (4x Agilex 7 F-Series)
#    - Ethereum mining (2020-2022)
#    - 4x Agilex AGF014 (1.4M logic cells each!)
#    - 32GB DDR4 per chip (128GB total)
#    - 12V input, onboard VRMs
#    - JTAG: 10-pin header (often unpopulated - solder header!)
#
# 2. Generic "Agilex Hashboard V2" (Chinese miners)
#    - 4x Agilex AGI027
#    - Ethereum/Ergo mining
#    - Cheaper build quality but same chips
#
# 3. "SQRL FK33" (Agilex variant)
#    - 2x Agilex chips
#    - More common, easier to find

# ============================================================================
# Power Considerations for Hashboards
# ============================================================================

# Mining hashboards typically use:
# - 12V DC input (barrel jack or PCIe power connector)
# - On-board VRMs (buck converters) for VCCINT (0.75V-0.9V)
# - High current draw (50-200A total for 4 chips!)
# - May require "enable" signal (pull-up resistor to 3.3V)

# Power-on sequence:
# 1. Apply 12V to main input
# 2. Check for 3.3V rail (should come up automatically)
# 3. Assert VRM enable (some boards need this)
# 4. Wait 1 second for VCCINT to stabilize
# 5. JTAG should be accessible

# ============================================================================
# JTAG Header Pinout (Common on Mining Hashboards)
# ============================================================================

# 10-pin Header (2x5, 0.1" pitch):
#  1  2      1: VREF (3.3V)     2: TMS
#  3  4      3: GND             4: TCK
#  5  6      5: GND             6: TDO
#  7  8      7: NC              8: TDI
#  9 10      9: GND            10: nTRST (optional)

# If header is unpopulated:
# - Solder a 2x5 0.1" header
# - Or use pogo pins / test clips

# ============================================================================
# Flash Configuration
# ============================================================================

# Agilex hashboards typically use:
# - Quad SPI Flash (256MB-512MB) for bitstream
# - May have encrypted bitstream (AES-256)
# - Erasing flash bypasses mining firmware

# Example flash bank (adjust size based on your board):
# flash bank agilex.qspi stmqspi 0x00000000 0x20000000 0 0 agilex0.fpga

# ============================================================================
# Programming Multiple Chips
# ============================================================================

# To program all 4 chips with same bitstream:
# init
# targets agilex0.fpga
# pld load 0 bitstream.rbf
# targets agilex1.fpga
# pld load 0 bitstream.rbf
# targets agilex2.fpga
# pld load 0 bitstream.rbf
# targets agilex3.fpga
# pld load 0 bitstream.rbf
# shutdown

# Or use Quartus Programmer:
# quartus_pgm -c USB-Blaster -m jtag -o "p@1;bitstream.rbf@1"
# quartus_pgm -c USB-Blaster -m jtag -o "p@2;bitstream.rbf@2"
# quartus_pgm -c USB-Blaster -m jtag -o "p@3;bitstream.rbf@3"
# quartus_pgm -c USB-Blaster -m jtag -o "p@4;bitstream.rbf@4"

# ============================================================================
# Troubleshooting
# ============================================================================

# Issue: "JTAG chain not detected"
# Solution:
#   1. Check 12V power is connected
#   2. Verify 3.3V rail (measure at JTAG pin 1)
#   3. Check VRM enable signal (may need jumper/resistor)
#   4. Try slower JTAG speed: adapter speed 1000

# Issue: "Only 1 chip detected instead of 4"
# Solution:
#   1. One chip may be dead (check which one)
#   2. JTAG chain break (inspect PCB traces)
#   3. Try targeting just working chips

# Issue: "Flash erase failed"
# Solution:
#   1. Mining boards often have write-protect fuses blown
#   2. Use JTAG-only mode (load bitstream directly, no flash)
#   3. Or desolder flash chip and replace

# ============================================================================
# Useful Commands
# ============================================================================

# Scan full JTAG chain:
#   openocd -f hashboard_agilex.cfg -c "init; scan_chain; shutdown"
#
# Expected output:
#   Info : JTAG tap: agilex0.tap tap/device found: 0x02E120DD
#   Info : JTAG tap: agilex1.tap tap/device found: 0x02E120DD
#   Info : JTAG tap: agilex2.tap tap/device found: 0x02E120DD
#   Info : JTAG tap: agilex3.tap tap/device found: 0x02E120DD
#
# Read device DNA (unique ID):
#   openocd -f hashboard_agilex.cfg -c "init; targets agilex0.fpga; shutdown"
#
# Program single chip:
#   quartus_pgm -c USB-Blaster -m jtag -o "p@1;diagnostic.rbf@1"

# ============================================================================
# AI Workload Recommendations
# ============================================================================

# 4x Agilex AGF014 = 5.6M logic cells, 14K DSP blocks total!
# Perfect for:
# - Massive SNN inference (10B+ synapses)
# - Distributed GNN training (graph partitioning across chips)
# - Large-scale molecular dynamics
# - Multi-FPGA deep learning inference pipeline

# Interconnect options:
# 1. PCIe (if hashboard has PCIe edge connector)
# 2. High-speed GPIO (LVDS pairs between chips)
# 3. Shared DDR4 (if boards support coherent memory)

# ============================================================================
# Safety Notes
# ============================================================================

# ⚠️ Mining hashboards can draw 200W+ at full load!
# - Ensure adequate cooling (add fans, heatsinks)
# - Monitor VRM temperatures (can exceed 100°C)
# - Start with low clock frequency (200MHz) then increase
# - Use current-limited 12V supply (start at 10A, monitor)

# ⚠️ Some boards have proprietary watchdogs
# - May reset if custom bitstream doesn't tickle watchdog
# - Solution: Disable watchdog in hardware (cut trace or remove IC)
#   or implement watchdog timer in your bitstream
